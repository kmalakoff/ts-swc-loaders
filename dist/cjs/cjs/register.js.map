{"version":3,"sources":["register.mjs"],"sourcesContent":["import path from 'path';\nimport pirates from 'pirates';\nimport '../polyfills.cjs';\n\nimport { createMatcher, transformSync } from 'ts-swc-transform';\n\nimport extensions from '../extensions.mjs';\nimport Cache from '../lib/Cache.mjs';\nimport loadTSConfig from '../lib/loadTSConfig.mjs';\n\nconst cache = new Cache();\nconst config = loadTSConfig(process.cwd());\nconfig.config.compilerOptions.module = 'CommonJS';\nconfig.config.compilerOptions.target = 'ES5';\nconst match = createMatcher(config);\n\nconst typeFileRegEx = /^[^.]+\\.d\\.(.*)$/;\n\nexport function register(options, hookOpts) {\n  options = options || {};\n  return pirates.addHook((code, filePath) => compile(code, filePath, options), Object.assign({ exts: extensions }, hookOpts || {}));\n}\n\nexport function compile(contents, filePath) {\n  const ext = path.extname(filePath);\n\n  // filter\n  if (!match(filePath)) return contents || ' ';\n  if (typeFileRegEx.test(filePath)) return ' ';\n  if (extensions.indexOf(ext) < 0) return contents || ' ';\n\n  const data = cache.getOrUpdate(cache.cachePath(filePath, config), contents, () => transformSync(contents, filePath, config));\n  return data.code;\n}\n"],"names":["compile","register","cache","Cache","config","loadTSConfig","process","cwd","compilerOptions","module","target","match","createMatcher","typeFileRegEx","options","hookOpts","pirates","addHook","code","filePath","Object","assign","exts","extensions","contents","ext","path","extname","test","indexOf","data","getOrUpdate","cachePath","transformSync"],"mappings":";;;;;;;;;;;IAuBgBA,OAAO;eAAPA;;IALAC,QAAQ;eAARA;;;2DAlBC;8DACG;QACb;8BAEsC;iEAEtB;4DACL;mEACO;;;;;;AAEzB,IAAMC,QAAQ,IAAIC,cAAK;AACvB,IAAMC,SAASC,IAAAA,qBAAY,EAACC,QAAQC,GAAG;AACvCH,OAAOA,MAAM,CAACI,eAAe,CAACC,MAAM,GAAG;AACvCL,OAAOA,MAAM,CAACI,eAAe,CAACE,MAAM,GAAG;AACvC,IAAMC,QAAQC,IAAAA,6BAAa,EAACR;AAE5B,IAAMS,gBAAgB;AAEf,SAASZ,SAASa,OAAO,EAAEC,QAAQ;IACxCD,UAAUA,WAAW,CAAC;IACtB,OAAOE,gBAAO,CAACC,OAAO,CAAC,SAACC,MAAMC;eAAanB,QAAQkB,MAAMC,UAAUL;OAAUM,OAAOC,MAAM,CAAC;QAAEC,MAAMC,mBAAU;IAAC,GAAGR,YAAY,CAAC;AAChI;AAEO,SAASf,QAAQwB,QAAQ,EAAEL,QAAQ;IACxC,IAAMM,MAAMC,aAAI,CAACC,OAAO,CAACR;IAEzB,SAAS;IACT,IAAI,CAACR,MAAMQ,WAAW,OAAOK,YAAY;IACzC,IAAIX,cAAce,IAAI,CAACT,WAAW,OAAO;IACzC,IAAII,mBAAU,CAACM,OAAO,CAACJ,OAAO,GAAG,OAAOD,YAAY;IAEpD,IAAMM,OAAO5B,MAAM6B,WAAW,CAAC7B,MAAM8B,SAAS,CAACb,UAAUf,SAASoB,UAAU;eAAMS,IAAAA,6BAAa,EAACT,UAAUL,UAAUf;;IACpH,OAAO0B,KAAKZ,IAAI;AAClB"}