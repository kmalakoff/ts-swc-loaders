{"version":3,"sources":["loaderCurrent.mjs"],"sourcesContent":["import { promises as fs } from 'node:fs';\nimport path from 'node:path';\nimport process from 'node:process';\nimport { fileURLToPath } from 'node:url';\n\nimport Cache from '../Cache.mjs';\nimport createMatcher from '../createMatcher.mjs';\nimport extensions from '../extensions.mjs';\nimport loadTSConfig from '../loadTSConfig.mjs';\nimport packageType from '../packageType.mjs';\nimport transformSync from '../transformSync.cjs';\n\nconst major = +process.versions.node.split('.')[0];\nconst importJSONKey = major >= 18 ? 'importAttributes' : 'importAssertions';\n\nconst moduleRegEx = /^[^.\\/]|^\\.[^.\\/]|^\\.\\.[^\\/]/;\nconst indexExtensions = extensions.map((x) => `index${x}`);\n\nconst cache = new Cache();\nconst config = loadTSConfig(path.resolve(process.cwd(), 'tsconfig.json'));\nconst match = createMatcher(config);\n\nexport async function resolve(specifier, context, next) {\n  // if (isBuiltin(specifier)) return next(specifier, context); // TODO: optimize, but not available on older node\n\n  // directory\n  if (specifier.endsWith('/')) {\n    const items = await fs.readdir(specifier);\n    for (const item of items) {\n      if (indexExtensions.indexOf(item) >= 0) {\n        return await resolve(specifier + item, context, next);\n      }\n    }\n  }\n  // no extension and not a module, guess an extension\n  else if (!path.extname(specifier) && !moduleRegEx.test(specifier)) {\n    // console.log(specifier, context.parentURL);\n    // const items = await fs.readdir(specifier); // TODO: search the directory\n    for (const ext of extensions) {\n      try {\n        return await resolve(specifier + ext, context, next);\n      } catch (_err) {\n        // skip\n      }\n    }\n  }\n\n  const data = await next(specifier, context);\n  if (!data.format) data.format = packageType(data.url);\n  if (specifier.endsWith('/node_modules/yargs/yargs')) data.format = 'commonjs'; // args bin is cjs in a module\n  return {\n    ...data,\n    shortCircuit: true,\n  };\n}\n\nexport async function load(url, context, next) {\n  if (url.startsWith('node:')) return await next(url, context, next);\n  if (url.endsWith('.json')) context[importJSONKey] = Object.assign(context[importJSONKey] || {}, { type: 'json' });\n\n  const loaded = await next(url, context);\n  const filePath = fileURLToPath(url);\n  const hasSource = loaded.source;\n  if (!hasSource) loaded.source = await fs.readFile(filePath);\n\n  // filter\n  if (!match(filePath)) return loaded;\n  if (url.endsWith('.d.ts'))\n    return {\n      ...loaded,\n      format: 'module',\n      source: '',\n    };\n  if (extensions.indexOf(path.extname(filePath)) < 0) return loaded;\n\n  // transform\n  const contents = loaded.source.toString();\n  const data = cache.getOrUpdate(cache.cachePath(filePath, config), contents, () => transformSync(contents, filePath, config));\n  return {\n    ...loaded,\n    format: hasSource ? 'module' : 'commonjs',\n    shortCircuit: true,\n    source: data.code,\n  };\n}\n"],"names":["load","resolve","major","process","versions","node","split","importJSONKey","moduleRegEx","indexExtensions","extensions","map","x","cache","Cache","config","loadTSConfig","path","cwd","match","createMatcher","specifier","context","next","items","item","ext","_err","data","endsWith","fs","readdir","indexOf","extname","test","format","packageType","url","shortCircuit","loaded","filePath","hasSource","contents","startsWith","Object","assign","type","fileURLToPath","source","readFile","toString","getOrUpdate","cachePath","transformSync","code"],"mappings":"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"}