{"version":3,"sources":["loaderCurrent.mjs"],"sourcesContent":["import { promises as fs } from 'node:fs';\nimport path from 'node:path';\nimport process from 'node:process';\n\nimport Cache from '../Cache.mjs';\nimport createMatcher from '../createMatcher.mjs';\nimport extensions from '../extensions.mjs';\nimport loadTSConfig from '../loadTSConfig.mjs';\nimport transformSync from '../transformSync.cjs';\nimport packageType from './packageType.mjs';\nimport toPath from './toPath.mjs';\n\nconst major = +process.versions.node.split('.')[0];\nconst importJSONKey = major >= 18 ? 'importAttributes' : 'importAssertions';\n\nconst moduleRegEx = /^[^.\\/]|^\\.[^.\\/]|^\\.\\.[^\\/]/;\nconst indexExtensions = extensions.map((x) => `index${x}`);\n\nconst cache = new Cache();\nconst config = loadTSConfig(path.resolve(process.cwd(), 'tsconfig.json'));\nconst match = createMatcher(config);\n\nexport async function resolve(specifier, context, next) {\n  if (specifier.startsWith('node:')) return next(specifier, context); // TODO: optimize, but isBuiltin not available on older node\n  const filePath = toPath(specifier, context);\n\n  // filtered\n  if (!match(filePath)) {\n    const data = await next(specifier, context);\n    if (!data.format) data.format = 'commonjs'\n    if(path.isAbsolute(filePath) && !path.extname(filePath)) data.format = 'commonjs'; // args bin is cjs in a module\n    return data;\n  }\n\n  // directory\n  if (specifier.endsWith('/')) {\n    const items = await fs.readdir(filePath);\n    for (const item of items) {\n      if (indexExtensions.indexOf(item) >= 0) {\n        return await resolve(specifier + item, context, next);\n      }\n    }\n  }\n  // look up the extension\n  else if (!path.extname(specifier) && !moduleRegEx.test(specifier)) {\n    const fileName = path.basename(filePath);\n    const items = await fs.readdir(path.dirname(filePath));\n    const found = items.find((x) => x.startsWith(fileName) && extensions.indexOf(path.extname(x)) >= 0);\n    if (found) return await resolve(specifier + path.extname(found), context, next);\n  }\n\n  // use default resolve and infer from package type\n  const data = await next(specifier, context);\n  if (!data.format) data.format = packageType(filePath);\n  return data;\n}\n\nexport async function load(url, context, next) {\n  if (url.startsWith('node:')) return await next(url, context, next);\n  if (url.endsWith('.json')) context[importJSONKey] = Object.assign(context[importJSONKey] || {}, { type: 'json' });\n\n  const loaded = await next(url, context);\n  const filePath = toPath(url, context);\n  const hasSource = loaded.source;\n  if (!hasSource) loaded.source = await fs.readFile(filePath);\n\n  // filtered\n  if (!match(filePath)) return loaded;\n  if (url.endsWith('.d.ts'))\n    return {\n      ...loaded,\n      format: 'module',\n      source: '',\n    };\n  if (extensions.indexOf(path.extname(filePath)) < 0) return loaded;\n\n  // transform\n  const contents = loaded.source.toString();\n  const data = cache.getOrUpdate(cache.cachePath(filePath, config), contents, () => transformSync(contents, filePath, config));\n  return {\n    ...loaded,\n    format: hasSource ? 'module' : 'commonjs',\n    source: data.code,\n    shortCircuit: true,\n  };\n}\n"],"names":["load","resolve","major","process","versions","node","split","importJSONKey","moduleRegEx","indexExtensions","extensions","map","x","cache","Cache","config","loadTSConfig","path","cwd","match","createMatcher","specifier","context","next","filePath","data","items","item","fileName","found","startsWith","toPath","format","isAbsolute","extname","endsWith","fs","readdir","indexOf","test","basename","dirname","find","packageType","url","loaded","hasSource","contents","Object","assign","type","source","readFile","toString","getOrUpdate","cachePath","transformSync","code","shortCircuit"],"mappings":"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"}