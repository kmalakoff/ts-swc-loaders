{"version":3,"sources":["loaderCurrent.mjs"],"sourcesContent":["import { promises as fs } from 'node:fs';\nimport path from 'node:path';\nimport process from 'node:process';\nimport { pathToFileURL } from 'node:url';\nimport isBuiltinModule from 'is-builtin-module';\nimport { createMatcher, transformSync } from 'ts-swc-transform';\n\nimport Cache from '../lib/Cache.mjs';\nimport extensions from '../extensions.mjs';\nimport loadTSConfig from '../lib/loadTSConfig.mjs';\nimport extToFormat from './extToFormat.mjs';\nimport fileType from './fileType.mjs';\nimport toPath from './toPath.mjs';\n\nconst major = +process.versions.node.split('.')[0];\nconst importJSONKey = major >= 18 ? 'importAttributes' : 'importAssertions';\n\nconst cache = new Cache();\nconst config = loadTSConfig(path.resolve(process.cwd(), 'tsconfig.json'));\nconst match = createMatcher(config);\n\nconst moduleRegEx = /^[^.\\/]|^\\.[^.\\/]|^\\.\\.[^\\/]/;\nconst typeFileRegEx = /^[^.]+\\.d\\.(.*)$/;\nconst indexExtensions = extensions.map((x) => `index${x}`);\n\nexport async function resolve(specifier, context, next) {\n  if (isBuiltinModule(specifier)) return next(specifier, context);\n  const filePath = toPath(specifier, context);\n  const ext = path.extname(filePath);\n  let stats;\n  try {\n    stats = await fs.stat(filePath);\n  } catch (_err) {}\n\n  // filtered\n  if (!match(filePath)) {\n    const data = await next(specifier, context);\n    if (!data.format) data.format = 'commonjs';\n    if (path.isAbsolute(filePath) && !ext) data.format = 'commonjs'; // args bin is cjs in a module\n    return data;\n  }\n\n  // directory\n  // biome-ignore lint/complexity/useOptionalChain: <explanation>\n  if (specifier.endsWith('/') || (stats && stats.isDirectory())) {\n    const items = await fs.readdir(filePath);\n    const item = items.find((x) => indexExtensions.indexOf(x) >= 0);\n    if (item) return await resolve(`${specifier}${specifier.endsWith('/') ? '' : '/'}${item}`, context, next);\n  }\n  // look up the extension\n  else if ((!ext && !moduleRegEx.test(specifier)) || !stats) {\n    const fileName = path.basename(filePath).replace(/(\\.[^/.]+)+$/, '');\n    const items = await fs.readdir(path.dirname(filePath));\n    const found = items.find((x) => x.startsWith(fileName) && !typeFileRegEx.test(x) && extensions.indexOf(path.extname(x)) >= 0);\n    if (found) return await resolve(specifier + path.extname(found), context, next);\n  }\n\n  // use default resolve and infer from package type\n  const data = {\n    url: pathToFileURL(filePath).href,\n    format: extToFormat(ext),\n    shortCircuit: true,\n  };\n  if (!data.format) data.format = fileType(filePath);\n  return data;\n}\n\nexport async function load(url, context, next) {\n  if (isBuiltinModule(url)) return next(url, context);\n  if (url.endsWith('.json')) context[importJSONKey] = Object.assign(context[importJSONKey] || {}, { type: 'json' });\n\n  const data = await next(url, context);\n  const filePath = toPath(data.responseURL || url, context);\n  const ext = path.extname(filePath);\n  if (!data.source && data.type === 'module') data.source = await fs.readFile(filePath);\n\n  // filtered\n  if (!match(filePath)) return data;\n  if (typeFileRegEx.test(filePath))\n    return {\n      ...data,\n      format: 'module',\n      source: '',\n    };\n  if (extensions.indexOf(ext) < 0) return data;\n\n  // transform\n  if (!data.source) data.source = await fs.readFile(filePath);\n  const contents = data.source.toString();\n  const compiled = cache.getOrUpdate(cache.cachePath(filePath, config), contents, () => transformSync(contents, filePath, config));\n  return {\n    ...data,\n    source: compiled.code,\n    shortCircuit: true,\n  };\n}\n"],"names":["load","resolve","major","process","versions","node","split","importJSONKey","cache","Cache","config","loadTSConfig","path","cwd","match","createMatcher","moduleRegEx","typeFileRegEx","indexExtensions","extensions","map","x","specifier","context","next","filePath","ext","stats","_err","data","items","item","fileName","found","isBuiltinModule","toPath","extname","fs","stat","format","isAbsolute","endsWith","isDirectory","readdir","find","indexOf","test","basename","replace","dirname","startsWith","url","pathToFileURL","href","extToFormat","shortCircuit","fileType","contents","compiled","Object","assign","type","responseURL","source","readFile","toString","getOrUpdate","cachePath","transformSync","code"],"mappings":"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"}