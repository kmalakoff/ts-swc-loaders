{"version":3,"sources":["loaderCurrent.mjs"],"sourcesContent":["import fs from 'fs';\nimport path from 'path';\nimport { URL, fileURLToPath, pathToFileURL } from 'url';\nimport process from 'process';\n\nimport Cache from '../Cache.mjs';\nimport createMatcher from '../createMatcher.mjs';\nimport extensions from '../extensions.mjs';\nimport loadTSConfig from '../loadTSConfig.mjs';\nimport packageType from '../packageType.mjs';\nimport transformSync from '../transformSync.cjs';\n\nconst major = +process.versions.node.split('.')[0];\nconst importJSONKey = major >= 18 ? 'importAttributes' : 'importAssertions';\n\nconst indexExtensions = extensions.map((x) => `index${x}`);\n\nconst cache = new Cache();\nconst config = loadTSConfig(path.resolve(process.cwd(), 'tsconfig.json'));\nconst match = createMatcher(config);\n\nexport async function resolve(specifier, context, defaultResolve) {\n  if (specifier.startsWith('node:')) specifier = specifier.slice(5); // node built-in\n  const parentURL = context.parentURL && path.isAbsolute(context.parentURL) ? pathToFileURL(context.parentURL) : context.parentURL; // windows\n  const url = parentURL ? new URL(specifier, parentURL).href : new URL(specifier).href;\n\n  // directory\n  if (specifier.endsWith('/')) {\n    const items = fs.readdirSync(specifier);\n    for (const item of items) {\n      if (indexExtensions.indexOf(item) >= 0) {\n        return await resolve(specifier + item, context, defaultResolve);\n      }\n    }\n  }\n\n  // default\n  const data = await defaultResolve(specifier, context, defaultResolve);\n  if (!data.format) data.format = packageType(url);\n  if (specifier.endsWith('/node_modules/yargs/yargs')) data.format = 'commonjs'; // args bin is cjs in a module\n  return data;\n}\n\nexport async function load(url, context, defaultLoad) {\n  if (url.startsWith('node:')) return await defaultLoad(url, context, defaultLoad);\n  if (url.endsWith('.json')) context[importJSONKey] = Object.assign(context[importJSONKey] || {}, { type: 'json' });\n\n  const parentURL = context.parentURL && path.isAbsolute(context.parentURL) ? pathToFileURL(context.parentURL) : context.parentURL; // windows\n  url = parentURL ? new URL(specifier, parentURL).href : url;\n\n  const loaded = await defaultLoad(url, context, defaultLoad);\n  const filePath = fileURLToPath(url);\n  const hasSource = loaded.source;\n  if (!hasSource) loaded.source = fs.readFileSync(filePath);\n\n  // filter\n  if (!match(filePath)) return loaded;\n  if (url.endsWith('.d.ts')) return { ...loaded, format: 'module', source: '' };\n  if (extensions.indexOf(path.extname(filePath)) < 0) return loaded;\n\n  // transform\n  const contents = loaded.source.toString();\n  const data = cache.getOrUpdate(cache.cachePath(filePath, config), contents, () => transformSync(contents, filePath, config));\n\n  return {\n    ...loaded,\n    format: hasSource ? 'module' : 'commonjs',\n    source: data.code,\n  };\n}\n"],"names":["load","resolve","major","process","versions","node","split","importJSONKey","indexExtensions","extensions","map","x","cache","Cache","config","loadTSConfig","path","cwd","match","createMatcher","specifier","context","defaultResolve","parentURL","url","items","item","data","startsWith","slice","isAbsolute","pathToFileURL","URL","href","endsWith","fs","readdirSync","indexOf","format","packageType","defaultLoad","loaded","filePath","hasSource","contents","Object","assign","type","fileURLToPath","source","readFileSync","extname","toString","getOrUpdate","cachePath","transformSync","code"],"mappings":"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"}