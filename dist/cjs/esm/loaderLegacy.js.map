{"version":3,"sources":["loaderLegacy.mjs"],"sourcesContent":["import path from 'path';\nimport { URL, fileURLToPath, pathToFileURL } from 'url';\n\nimport Cache from '../Cache.mjs';\nimport createMatcher from '../createMatcher.mjs';\nimport extensions from '../extensions.mjs';\nimport loadTSConfig from '../loadTSConfig.mjs';\nimport packageType from '../packageType.mjs';\nimport transformSync from './transformSync.mjs';\n\nconst INTERNAL_PATHS = [new URL('..', import.meta.url).href, new URL('../../node_modules', import.meta.url).href];\nconst isInternal = (x) => INTERNAL_PATHS.some((y) => x.startsWith(y));\n\nconst EXT_TO_FORMAT = {\n  '.json': 'json',\n  '.mjs': 'module',\n  '.mts': 'module',\n  '.cjs': 'commonjs',\n  '.cts': 'commonjs',\n};\n\nconst cache = new Cache();\nconst config = loadTSConfig(path.resolve(process.cwd(), 'tsconfig.json'));\nconst match = createMatcher(config);\n\nasync function _getFormat(url, context, defaultGetFormat) {\n  const parentURL = context.parentURL && path.isAbsolute(context.parentURL) ? pathToFileURL(context.parentURL) : context.parentURL; // windows\n  url = parentURL ? new URL(specifier, parentURL).href : url;\n\n  // internals\n  if (isInternal(url)) return { format: packageType(url) };\n\n  // file\n  if (url.startsWith('file://')) {\n    const ext = path.extname(url);\n    let format = EXT_TO_FORMAT[ext];\n    if (!format) format = ext.length ? packageType(url) : 'commonjs'; // no extension assume commonjs\n    return { format };\n  }\n\n  // relative\n  return await defaultGetFormat(url, context, defaultGetFormat);\n}\n\nasync function _transformSource(source, context, defaultTransformSource) {\n  let { url } = context;\n  const parentURL = context.parentURL && path.isAbsolute(context.parentURL) ? pathToFileURL(context.parentURL) : context.parentURL; // windows\n  url = parentURL ? new URL(specifier, parentURL).href : url;\n  const loaded = await defaultTransformSource(source, context, defaultTransformSource);\n  const filePath = fileURLToPath(url);\n\n  // filter\n  if (isInternal(url)) return loaded;\n  if (url.endsWith('.d.ts')) return { source: '' };\n  if (extensions.indexOf(path.extname(filePath)) < 0) return loaded;\n  if (!match(filePath)) return loaded;\n\n  const contents = loaded.source.toString();\n  const data = cache.getOrUpdate(cache.cachePath(filePath, config), contents, () => transformSync(contents, filePath, config));\n\n  return {\n    source: data.code,\n  };\n}\n\nconst major = +process.versions.node.split('.')[0];\n\nexport const getFormat = major < 16 ? _getFormat : undefined;\nexport const transformSource = major < 16 ? _transformSource : undefined;\n"],"names":["getFormat","transformSource","INTERNAL_PATHS","URL","href","isInternal","x","some","y","startsWith","EXT_TO_FORMAT","cache","Cache","config","loadTSConfig","path","resolve","process","cwd","match","createMatcher","_getFormat","url","context","defaultGetFormat","parentURL","ext","format","isAbsolute","pathToFileURL","specifier","packageType","extname","length","_transformSource","source","defaultTransformSource","loaded","filePath","contents","data","fileURLToPath","endsWith","extensions","indexOf","toString","getOrUpdate","cachePath","transformSync","code","major","versions","node","split","undefined"],"mappings":"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"}