{"version":3,"sources":["loaderLegacy.mjs"],"sourcesContent":["import path from 'path';\nimport isBuiltinModule from 'is-builtin-module';\nimport { createMatcher, transformSync } from 'ts-swc-transform';\n\nimport Cache from '../lib/Cache.mjs';\nimport extensions from '../extensions.mjs';\nimport loadTSConfig from '../lib/loadTSConfig.mjs';\nimport extToFormat from './extToFormat.mjs';\nimport fileType from './fileType.mjs';\nimport toPath from './toPath.mjs';\n\nconst cache = new Cache();\nconst config = loadTSConfig(path.resolve(process.cwd(), 'tsconfig.json'));\nconst match = createMatcher(config);\n\nconst typeFileRegEx = /^[^.]+\\.d\\.(.*)$/;\n\nasync function _getFormat(url, context, next) {\n  if (isBuiltinModule(url)) return next(url, context);\n  if (!url.startsWith('file://')) return await next(url, context);\n  const filePath = toPath(url, context);\n  const ext = path.extname(filePath);\n\n  // filtered\n  if (!match(filePath)) {\n    if (!ext) return { format: 'commonjs' }; // args bin is cjs in a module\n    return await next(url, context);\n  }\n\n  // file\n  const data = { format: extToFormat(ext) };\n  if (!data.format || ['.js', '.jsx'].indexOf(ext) >= 0) data.format = fileType(filePath);\n  return data;\n}\n\nasync function _transformSource(source, context, next) {\n  if (isBuiltinModule(context.url)) return next(source, context);\n  const loaded = await next(source, context);\n  const filePath = toPath(context.url);\n  const ext = path.extname(filePath);\n\n  // filtered\n  if (!match(filePath)) return loaded;\n  if (typeFileRegEx.test(filePath)) return { source: '' };\n  if (extensions.indexOf(ext) < 0) return loaded;\n\n  const contents = loaded.source.toString();\n  const compiled = cache.getOrUpdate(cache.cachePath(filePath, config), contents, () => transformSync(contents, filePath, config));\n\n  return {\n    source: compiled.code,\n  };\n}\n\nconst major = +process.versions.node.split('.')[0];\n\nexport const getFormat = major < 16 ? _getFormat : undefined;\nexport const transformSource = major < 16 ? _transformSource : undefined;\n"],"names":["getFormat","transformSource","cache","Cache","config","loadTSConfig","path","resolve","process","cwd","match","createMatcher","typeFileRegEx","_getFormat","url","context","next","filePath","ext","data","isBuiltinModule","startsWith","toPath","extname","format","extToFormat","indexOf","fileType","_transformSource","source","loaded","contents","compiled","test","extensions","toString","getOrUpdate","cachePath","transformSync","code","major","versions","node","split","undefined"],"mappings":";;;;;;;;;;;IAwDaA,SAAS;eAATA;;IACAC,eAAe;eAAfA;;;2DAzDI;sEACW;8BACiB;4DAE3B;iEACK;mEACE;kEACD;+DACH;6DACF;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAEnB,IAAMC,QAAQ,IAAIC,cAAK;AACvB,IAAMC,SAASC,IAAAA,qBAAY,EAACC,aAAI,CAACC,OAAO,CAACC,QAAQC,GAAG,IAAI;AACxD,IAAMC,QAAQC,IAAAA,6BAAa,EAACP;AAE5B,IAAMQ,gBAAgB;SAEPC,WAAWC,GAAG,EAAEC,OAAO,EAAEC,IAAI;WAA7BH;;SAAAA;IAAAA,cAAf,oBAAA,SAA0BC,GAAG,EAAEC,OAAO,EAAEC,IAAI;YAGpCC,UACAC,KASAC;;;;oBAZN,IAAIC,IAAAA,wBAAe,EAACN,MAAM;;wBAAOE,KAAKF,KAAKC;;yBACvC,CAACD,IAAIO,UAAU,CAAC,YAAhB;;;;oBAAmC;;wBAAML,KAAKF,KAAKC;;;oBAAvB;;wBAAO;;;oBACjCE,WAAWK,IAAAA,eAAM,EAACR,KAAKC;oBACvBG,MAAMZ,aAAI,CAACiB,OAAO,CAACN;yBAGrB,CAACP,MAAMO,WAAP;;;;oBACF,IAAI,CAACC,KAAK;;wBAAO;4BAAEM,QAAQ;wBAAW;uBAAG,8BAA8B;oBAChE;;wBAAMR,KAAKF,KAAKC;;;oBAAvB;;wBAAO;;;oBAGT,OAAO;oBACDI,OAAO;wBAAEK,QAAQC,IAAAA,oBAAW,EAACP;oBAAK;oBACxC,IAAI,CAACC,KAAKK,MAAM,IAAI;wBAAC;wBAAO;sBAAQE,OAAO,CAACR,QAAQ,GAAGC,KAAKK,MAAM,GAAGG,IAAAA,iBAAQ,EAACV;oBAC9E;;wBAAOE;;;;IACT;WAhBeN;;SAkBAe,iBAAiBC,MAAM,EAAEd,OAAO,EAAEC,IAAI;WAAtCY;;SAAAA;IAAAA,oBAAf,oBAAA,SAAgCC,MAAM,EAAEd,OAAO,EAAEC,IAAI;YAE7Cc,QACAb,UACAC,KAOAa,UACAC;;;;oBAXN,IAAIZ,IAAAA,wBAAe,EAACL,QAAQD,GAAG,GAAG;;wBAAOE,KAAKa,QAAQd;;oBACvC;;wBAAMC,KAAKa,QAAQd;;;oBAA5Be,SAAS;oBACTb,WAAWK,IAAAA,eAAM,EAACP,QAAQD,GAAG;oBAC7BI,MAAMZ,aAAI,CAACiB,OAAO,CAACN;oBAEzB,WAAW;oBACX,IAAI,CAACP,MAAMO,WAAW;;wBAAOa;;oBAC7B,IAAIlB,cAAcqB,IAAI,CAAChB,WAAW;;wBAAO;4BAAEY,QAAQ;wBAAG;;oBACtD,IAAIK,mBAAU,CAACR,OAAO,CAACR,OAAO,GAAG;;wBAAOY;;oBAElCC,WAAWD,OAAOD,MAAM,CAACM,QAAQ;oBACjCH,WAAW9B,MAAMkC,WAAW,CAAClC,MAAMmC,SAAS,CAACpB,UAAUb,SAAS2B,UAAU;+BAAMO,IAAAA,6BAAa,EAACP,UAAUd,UAAUb;;oBAExH;;wBAAO;4BACLyB,QAAQG,SAASO,IAAI;wBACvB;;;;IACF;WAjBeX;;AAmBf,IAAMY,QAAQ,CAAChC,QAAQiC,QAAQ,CAACC,IAAI,CAACC,KAAK,CAAC,IAAI,CAAC,EAAE;AAE3C,IAAM3C,YAAYwC,QAAQ,KAAK3B,aAAa+B;AAC5C,IAAM3C,kBAAkBuC,QAAQ,KAAKZ,mBAAmBgB"}