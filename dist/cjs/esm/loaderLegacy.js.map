{"version":3,"sources":["loaderLegacy.mjs"],"sourcesContent":["import path from 'path';\n\nimport Cache from '../Cache.mjs';\nimport createMatcher from '../createMatcher.mjs';\nimport extensions from '../extensions.mjs';\nimport loadTSConfig from '../loadTSConfig.mjs';\nimport transformSync from '../transformSync.cjs';\nimport packageType from './packageType.mjs';\nimport toPath from './toPath.mjs';\n\nconst EXT_TO_FORMAT = {\n  '.json': 'json',\n  '.mjs': 'module',\n  '.mts': 'module',\n  '.cjs': 'commonjs',\n  '.cts': 'commonjs',\n};\n\nconst cache = new Cache();\nconst config = loadTSConfig(path.resolve(process.cwd(), 'tsconfig.json'));\nconst match = createMatcher(config);\n\nasync function _getFormat(url, context, next) {\n  if (!url.startsWith('file://')) return await next(url, context);\n  const filePath = toPath(url, context);\n\n  // filtered\n  if (!match(filePath)) {\n    if(!path.extname(filePath)) return { format: 'commonjs' }; // args bin is cjs in a module\n    return await next(url, context);\n  }\n\n  // file\n  const data = { format: EXT_TO_FORMAT[path.extname(url)] };\n  if (!data.format) data.format = await packageType(filePath);\n  return data;\n}\n\nasync function _transformSource(source, context, next) {\n  const loaded = await next(source, context);\n  const filePath = toPath(context.url);\n\n  // filtered\n  if (!match(filePath)) return loaded;\n  if (filePath.endsWith('.d.ts')) return { source: '' };\n  if (extensions.indexOf(path.extname(filePath)) < 0) return loaded;\n\n  const contents = loaded.source.toString();\n  const data = cache.getOrUpdate(cache.cachePath(filePath, config), contents, () => transformSync(contents, filePath, config));\n\n  return {\n    source: data.code,\n  };\n}\n\nconst major = +process.versions.node.split('.')[0];\n\nexport const getFormat = major < 16 ? _getFormat : undefined;\nexport const transformSource = major < 16 ? _transformSource : undefined;\n"],"names":["getFormat","transformSource","EXT_TO_FORMAT","cache","Cache","config","loadTSConfig","path","resolve","process","cwd","match","createMatcher","_getFormat","url","context","next","filePath","data","startsWith","toPath","extname","format","packageType","_transformSource","source","loaded","contents","endsWith","extensions","indexOf","toString","getOrUpdate","cachePath","transformSync","code","major","versions","node","split","undefined"],"mappings":";;;;;;;;;;;IAyDaA,SAAS;eAATA;;IACAC,eAAe;eAAfA;;;2DA1DI;4DAEC;oEACQ;iEACH;mEACE;uEACC;kEACF;6DACL;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAEnB,IAAMC,gBAAgB;IACpB,SAAS;IACT,QAAQ;IACR,QAAQ;IACR,QAAQ;IACR,QAAQ;AACV;AAEA,IAAMC,QAAQ,IAAIC,cAAK;AACvB,IAAMC,SAASC,IAAAA,qBAAY,EAACC,aAAI,CAACC,OAAO,CAACC,QAAQC,GAAG,IAAI;AACxD,IAAMC,QAAQC,IAAAA,sBAAa,EAACP;SAEbQ,WAAWC,GAAG,EAAEC,OAAO,EAAEC,IAAI;WAA7BH;;SAAAA;IAAAA,cAAf,oBAAA,SAA0BC,GAAG,EAAEC,OAAO,EAAEC,IAAI;YAEpCC,UASAC;;;;yBAVF,CAACJ,IAAIK,UAAU,CAAC,YAAhB;;;;oBAAmC;;wBAAMH,KAAKF,KAAKC;;;oBAAvB;;wBAAO;;;oBACjCE,WAAWG,IAAAA,eAAM,EAACN,KAAKC;yBAGzB,CAACJ,MAAMM,WAAP;;;;oBACF,IAAG,CAACV,aAAI,CAACc,OAAO,CAACJ,WAAW;;wBAAO;4BAAEK,QAAQ;wBAAW;uBAAG,8BAA8B;oBAClF;;wBAAMN,KAAKF,KAAKC;;;oBAAvB;;wBAAO;;;oBAGT,OAAO;oBACDG,OAAO;wBAAEI,QAAQpB,aAAa,CAACK,aAAI,CAACc,OAAO,CAACP,KAAK;oBAAC;yBACpD,CAACI,KAAKI,MAAM,EAAZ;;;;oBAA4B;;wBAAMC,IAAAA,oBAAW,EAACN;;;oBAAhCC,KAAKI,MAAM,GAAG;;;oBAChC;;wBAAOJ;;;;IACT;WAdeL;;SAgBAW,iBAAiBC,MAAM,EAAEV,OAAO,EAAEC,IAAI;WAAtCQ;;SAAAA;IAAAA,oBAAf,oBAAA,SAAgCC,MAAM,EAAEV,OAAO,EAAEC,IAAI;YAC7CU,QACAT,UAOAU,UACAT;;;;oBATS;;wBAAMF,KAAKS,QAAQV;;;oBAA5BW,SAAS;oBACTT,WAAWG,IAAAA,eAAM,EAACL,QAAQD,GAAG;oBAEnC,WAAW;oBACX,IAAI,CAACH,MAAMM,WAAW;;wBAAOS;;oBAC7B,IAAIT,SAASW,QAAQ,CAAC,UAAU;;wBAAO;4BAAEH,QAAQ;wBAAG;;oBACpD,IAAII,mBAAU,CAACC,OAAO,CAACvB,aAAI,CAACc,OAAO,CAACJ,aAAa,GAAG;;wBAAOS;;oBAErDC,WAAWD,OAAOD,MAAM,CAACM,QAAQ;oBACjCb,OAAOf,MAAM6B,WAAW,CAAC7B,MAAM8B,SAAS,CAAChB,UAAUZ,SAASsB,UAAU;+BAAMO,IAAAA,yBAAa,EAACP,UAAUV,UAAUZ;;oBAEpH;;wBAAO;4BACLoB,QAAQP,KAAKiB,IAAI;wBACnB;;;;IACF;WAfeX;;AAiBf,IAAMY,QAAQ,CAAC3B,QAAQ4B,QAAQ,CAACC,IAAI,CAACC,KAAK,CAAC,IAAI,CAAC,EAAE;AAE3C,IAAMvC,YAAYoC,QAAQ,KAAKvB,aAAa2B;AAC5C,IAAMvC,kBAAkBmC,QAAQ,KAAKZ,mBAAmBgB"}