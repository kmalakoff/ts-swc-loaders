{"version":3,"sources":["loaderLegacy.mjs"],"sourcesContent":["import path from 'path';\nimport isBuiltinModule from 'is-builtin-module';\nimport { createMatcher, transformSync } from 'ts-swc-transform';\n\nimport extensions from '../extensions.mjs';\nimport Cache from '../lib/Cache.mjs';\nimport loadTSConfig from '../lib/loadTSConfig.mjs';\nimport extToFormat from './extToFormat.mjs';\nimport fileType from './fileType.mjs';\nimport toPath from './toPath.mjs';\n\nconst cache = new Cache();\nconst config = loadTSConfig(process.cwd());\nconst match = createMatcher(config);\n\nconst typeFileRegEx = /^[^.]+\\.d\\.(.*)$/;\n\nasync function _getFormat(url, context, next) {\n  if (isBuiltinModule(url)) return next(url, context);\n  if (!url.startsWith('file://')) return await next(url, context);\n  const filePath = toPath(url, context);\n  const ext = path.extname(filePath);\n\n  // filtered\n  if (!match(filePath)) {\n    if (!ext) return { format: 'commonjs' }; // args bin is cjs in a module\n    return await next(url, context);\n  }\n\n  // file\n  const data = { format: extToFormat(ext) };\n  if (!data.format || ['.js', '.jsx'].indexOf(ext) >= 0) data.format = fileType(filePath);\n  return data;\n}\n\nasync function _transformSource(source, context, next) {\n  if (isBuiltinModule(context.url)) return next(source, context);\n  const loaded = await next(source, context);\n  const filePath = toPath(context.url);\n  const ext = path.extname(filePath);\n\n  // filtered\n  if (!match(filePath)) return loaded;\n  if (typeFileRegEx.test(filePath)) return { source: '' };\n  if (extensions.indexOf(ext) < 0) return loaded;\n\n  const contents = loaded.source.toString();\n  const compiled = cache.getOrUpdate(cache.cachePath(filePath, config), contents, () => transformSync(contents, filePath, config));\n\n  return {\n    source: compiled.code,\n  };\n}\n\nconst major = +process.versions.node.split('.')[0];\n\nexport const getFormat = major < 16 ? _getFormat : undefined;\nexport const transformSource = major < 16 ? _transformSource : undefined;\n"],"names":["getFormat","transformSource","cache","Cache","config","loadTSConfig","process","cwd","match","createMatcher","typeFileRegEx","_getFormat","url","context","next","filePath","ext","data","isBuiltinModule","startsWith","toPath","path","extname","format","extToFormat","indexOf","fileType","_transformSource","source","loaded","contents","compiled","test","extensions","toString","getOrUpdate","cachePath","transformSync","code","major","versions","node","split","undefined"],"mappings":";;;;;;;;;;;IAwDaA,SAAS;eAATA;;IACAC,eAAe;eAAfA;;;2DAzDI;sEACW;8BACiB;iEAEtB;4DACL;mEACO;kEACD;+DACH;6DACF;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAEnB,IAAMC,QAAQ,IAAIC,cAAK;AACvB,IAAMC,SAASC,IAAAA,qBAAY,EAACC,QAAQC,GAAG;AACvC,IAAMC,QAAQC,IAAAA,6BAAa,EAACL;AAE5B,IAAMM,gBAAgB;SAEPC,WAAWC,GAAG,EAAEC,OAAO,EAAEC,IAAI;WAA7BH;;SAAAA;IAAAA,cAAf,oBAAA,SAA0BC,GAAG,EAAEC,OAAO,EAAEC,IAAI;YAGpCC,UACAC,KASAC;;;;oBAZN,IAAIC,IAAAA,wBAAe,EAACN,MAAM;;wBAAOE,KAAKF,KAAKC;;yBACvC,CAACD,IAAIO,UAAU,CAAC,YAAhB;;;;oBAAmC;;wBAAML,KAAKF,KAAKC;;;oBAAvB;;wBAAO;;;oBACjCE,WAAWK,IAAAA,eAAM,EAACR,KAAKC;oBACvBG,MAAMK,aAAI,CAACC,OAAO,CAACP;yBAGrB,CAACP,MAAMO,WAAP;;;;oBACF,IAAI,CAACC,KAAK;;wBAAO;4BAAEO,QAAQ;wBAAW;uBAAG,8BAA8B;oBAChE;;wBAAMT,KAAKF,KAAKC;;;oBAAvB;;wBAAO;;;oBAGT,OAAO;oBACDI,OAAO;wBAAEM,QAAQC,IAAAA,oBAAW,EAACR;oBAAK;oBACxC,IAAI,CAACC,KAAKM,MAAM,IAAI;wBAAC;wBAAO;sBAAQE,OAAO,CAACT,QAAQ,GAAGC,KAAKM,MAAM,GAAGG,IAAAA,iBAAQ,EAACX;oBAC9E;;wBAAOE;;;;IACT;WAhBeN;;SAkBAgB,iBAAiBC,MAAM,EAAEf,OAAO,EAAEC,IAAI;WAAtCa;;SAAAA;IAAAA,oBAAf,oBAAA,SAAgCC,MAAM,EAAEf,OAAO,EAAEC,IAAI;YAE7Ce,QACAd,UACAC,KAOAc,UACAC;;;;oBAXN,IAAIb,IAAAA,wBAAe,EAACL,QAAQD,GAAG,GAAG;;wBAAOE,KAAKc,QAAQf;;oBACvC;;wBAAMC,KAAKc,QAAQf;;;oBAA5BgB,SAAS;oBACTd,WAAWK,IAAAA,eAAM,EAACP,QAAQD,GAAG;oBAC7BI,MAAMK,aAAI,CAACC,OAAO,CAACP;oBAEzB,WAAW;oBACX,IAAI,CAACP,MAAMO,WAAW;;wBAAOc;;oBAC7B,IAAInB,cAAcsB,IAAI,CAACjB,WAAW;;wBAAO;4BAAEa,QAAQ;wBAAG;;oBACtD,IAAIK,mBAAU,CAACR,OAAO,CAACT,OAAO,GAAG;;wBAAOa;;oBAElCC,WAAWD,OAAOD,MAAM,CAACM,QAAQ;oBACjCH,WAAW7B,MAAMiC,WAAW,CAACjC,MAAMkC,SAAS,CAACrB,UAAUX,SAAS0B,UAAU;+BAAMO,IAAAA,6BAAa,EAACP,UAAUf,UAAUX;;oBAExH;;wBAAO;4BACLwB,QAAQG,SAASO,IAAI;wBACvB;;;;IACF;WAjBeX;;AAmBf,IAAMY,QAAQ,CAACjC,QAAQkC,QAAQ,CAACC,IAAI,CAACC,KAAK,CAAC,IAAI,CAAC,EAAE;AAE3C,IAAM1C,YAAYuC,QAAQ,KAAK5B,aAAagC;AAC5C,IAAM1C,kBAAkBsC,QAAQ,KAAKZ,mBAAmBgB"}