{"version":3,"sources":["Cache.mjs"],"sourcesContent":["import fs from 'fs';\nimport os from 'os';\nimport path from 'path';\nimport osShim from 'os-shim';\n\nimport mkdirp from 'mkdirp';\nimport shortHash from 'short-hash';\n\nconst tmpdir = os.tmpdir || osShim.tmpdir;\n\nfunction unlinkSafe(filePath) {\n  try {\n    fs.unlinkSync(filePath);\n  } catch (_err) {\n    // skip\n  }\n}\nfunction timeMS() {\n  return new Date().valueOf();\n}\nconst MS_TO_DAYS = 1000 * 60 * 60 * 24;\n\nexport default class Cache {\n  constructor(options) {\n    options = options || {};\n    this.cwd = process.cwd();\n    this.cwdHash = shortHash(process.cwd());\n    this.root = options.root || path.join(tmpdir(), 'ts-swc-loaders');\n    this.maxAge = options.maxAge || 1 * MS_TO_DAYS;\n  }\n\n  cachePath(filePath, options) {\n    const relFilePath = path.relative(this.cwd, filePath);\n    let basename = path.basename(relFilePath);\n    const dirHash = shortHash(path.dirname(relFilePath));\n    if (options) basename += `-${shortHash(JSON.stringify(options || {}))}`;\n    return path.join(this.root, this.cwdHash, dirHash, `${basename}.json`);\n  }\n\n  get(cachePath) {\n    const record = this.getRecord(cachePath);\n    return record ? record.data : null;\n  }\n\n  getRecord(cachePath) {\n    try {\n      const record = JSON.parse(fs.readFileSync(cachePath, 'utf8'));\n      const time = timeMS();\n      if (time - record.time > this.maxAge) {\n        unlinkSafe(cachePath);\n        return null;\n      }\n      return record;\n    } catch (_err) {\n      return null;\n    }\n  }\n\n  getOrUpdate(cachePath, contents, fn) {\n    const hash = shortHash(contents);\n    const record = this.getRecord(cachePath);\n    if (record && record.hash === hash) return record.data;\n\n    // miss\n    const data = fn(contents);\n    this.set(cachePath, data, { hash: hash });\n    return data;\n  }\n\n  set(cachePath, data, options) {\n    options = options || {};\n    const record = {\n      data: data,\n      time: options.time || timeMS(),\n      hash: options.hash,\n    };\n    mkdirp.sync(path.dirname(cachePath));\n    fs.writeFileSync(cachePath, JSON.stringify(record), 'utf8');\n  }\n}\n"],"names":["fs","os","path","osShim","mkdirp","shortHash","tmpdir","unlinkSafe","filePath","unlinkSync","_err","timeMS","Date","valueOf","MS_TO_DAYS","Cache","cachePath","options","relFilePath","relative","cwd","basename","dirHash","dirname","JSON","stringify","join","root","cwdHash","get","record","getRecord","data","parse","readFileSync","time","maxAge","getOrUpdate","contents","fn","hash","set","sync","writeFileSync","constructor","process"],"mappings":"AAAA,OAAOA,QAAQ,KAAK;AACpB,OAAOC,QAAQ,KAAK;AACpB,OAAOC,UAAU,OAAO;AACxB,OAAOC,YAAY,UAAU;AAE7B,OAAOC,YAAY,SAAS;AAC5B,OAAOC,eAAe,aAAa;AAEnC,MAAMC,SAASL,GAAGK,MAAM,IAAIH,OAAOG,MAAM;AAEzC,SAASC,WAAWC,QAAQ;IAC1B,IAAI;QACFR,GAAGS,UAAU,CAACD;IAChB,EAAE,OAAOE,MAAM;IACb,OAAO;IACT;AACF;AACA,SAASC;IACP,OAAO,IAAIC,OAAOC,OAAO;AAC3B;AACA,MAAMC,aAAa,OAAO,KAAK,KAAK;AAErB,IAAA,AAAMC,QAAN,MAAMA;IASnBC,UAAUR,QAAQ,EAAES,OAAO,EAAE;QAC3B,MAAMC,cAAchB,KAAKiB,QAAQ,CAAC,IAAI,CAACC,GAAG,EAAEZ;QAC5C,IAAIa,WAAWnB,KAAKmB,QAAQ,CAACH;QAC7B,MAAMI,UAAUjB,UAAUH,KAAKqB,OAAO,CAACL;QACvC,IAAID,SAASI,YAAY,CAAC,CAAC,EAAEhB,UAAUmB,KAAKC,SAAS,CAACR,WAAW,CAAC,KAAK;QACvE,OAAOf,KAAKwB,IAAI,CAAC,IAAI,CAACC,IAAI,EAAE,IAAI,CAACC,OAAO,EAAEN,SAAS,GAAGD,SAAS,KAAK,CAAC;IACvE;IAEAQ,IAAIb,SAAS,EAAE;QACb,MAAMc,SAAS,IAAI,CAACC,SAAS,CAACf;QAC9B,OAAOc,SAASA,OAAOE,IAAI,GAAG;IAChC;IAEAD,UAAUf,SAAS,EAAE;QACnB,IAAI;YACF,MAAMc,SAASN,KAAKS,KAAK,CAACjC,GAAGkC,YAAY,CAAClB,WAAW;YACrD,MAAMmB,OAAOxB;YACb,IAAIwB,OAAOL,OAAOK,IAAI,GAAG,IAAI,CAACC,MAAM,EAAE;gBACpC7B,WAAWS;gBACX,OAAO;YACT;YACA,OAAOc;QACT,EAAE,OAAOpB,MAAM;YACb,OAAO;QACT;IACF;IAEA2B,YAAYrB,SAAS,EAAEsB,QAAQ,EAAEC,EAAE,EAAE;QACnC,MAAMC,OAAOnC,UAAUiC;QACvB,MAAMR,SAAS,IAAI,CAACC,SAAS,CAACf;QAC9B,IAAIc,UAAUA,OAAOU,IAAI,KAAKA,MAAM,OAAOV,OAAOE,IAAI;QAEtD,OAAO;QACP,MAAMA,OAAOO,GAAGD;QAChB,IAAI,CAACG,GAAG,CAACzB,WAAWgB,MAAM;YAAEQ,MAAMA;QAAK;QACvC,OAAOR;IACT;IAEAS,IAAIzB,SAAS,EAAEgB,IAAI,EAAEf,OAAO,EAAE;QAC5BA,UAAUA,WAAW,CAAC;QACtB,MAAMa,SAAS;YACbE,MAAMA;YACNG,MAAMlB,QAAQkB,IAAI,IAAIxB;YACtB6B,MAAMvB,QAAQuB,IAAI;QACpB;QACApC,OAAOsC,IAAI,CAACxC,KAAKqB,OAAO,CAACP;QACzBhB,GAAG2C,aAAa,CAAC3B,WAAWQ,KAAKC,SAAS,CAACK,SAAS;IACtD;IAvDAc,YAAY3B,OAAO,CAAE;QACnBA,UAAUA,WAAW,CAAC;QACtB,IAAI,CAACG,GAAG,GAAGyB,QAAQzB,GAAG;QACtB,IAAI,CAACQ,OAAO,GAAGvB,UAAUwC,QAAQzB,GAAG;QACpC,IAAI,CAACO,IAAI,GAAGV,QAAQU,IAAI,IAAIzB,KAAKwB,IAAI,CAACpB,UAAU;QAChD,IAAI,CAAC8B,MAAM,GAAGnB,QAAQmB,MAAM,IAAI,IAAItB;IACtC;AAkDF;AAzDA,SAAqBC,mBAyDpB"}