{"version":3,"sources":["register.mjs"],"sourcesContent":["import path from 'path';\nimport pirates from 'pirates';\nimport '../polyfills.cjs';\n\nimport Cache from '../Cache.js';\nimport createMatcher from '../createMatcher.mjs';\nimport extensions from '../extensions.mjs';\nimport loadTSConfig from '../loadTSConfig.mjs';\nimport transformSync from '../transformSync.cjs';\n\nconst INTERNAL_PATHS = [path.resolve(__dirname, '..'), path.resolve(__dirname, '..', '..', 'node_modules')];\nfunction isInternal(x) {\n  return INTERNAL_PATHS.some((y) => x.startsWith(y));\n}\n\nconst cache = new Cache();\nconst config = loadTSConfig(path.resolve(process.cwd(), 'tsconfig.json'));\nconfig.config.compilerOptions.module = 'CommonJS';\nconfig.config.compilerOptions.target = 'ES5';\nconst match = createMatcher(config);\n\nexport function register(options, hookOpts) {\n  options = options || {};\n  return pirates.addHook((code, filePath) => compile(code, filePath, options), Object.assign({ exts: extensions }, hookOpts || {}));\n}\n\nexport function compile(contents, filePath) {\n  // filter\n  if (isInternal(filePath)) return contents;\n  if (filePath.endsWith('.d.ts')) return ' ';\n  if (extensions.indexOf(path.extname(filePath)) < 0) return contents || ' ';\n  if (!match(filePath)) return contents || ' ';\n\n  const data = cache.getOrUpdate(cache.cachePath(filePath, config), contents, () => transformSync(contents, filePath, config));\n  return data.code;\n}\n"],"names":["path","pirates","Cache","createMatcher","extensions","loadTSConfig","transformSync","INTERNAL_PATHS","resolve","__dirname","isInternal","x","some","y","startsWith","cache","config","process","cwd","compilerOptions","module","target","match","register","options","hookOpts","addHook","code","filePath","compile","Object","assign","exts","contents","endsWith","indexOf","extname","data","getOrUpdate","cachePath"],"mappings":"AAAA,OAAOA,UAAU,OAAO;AACxB,OAAOC,aAAa,UAAU;AAC9B,OAAO,mBAAmB;AAE1B,OAAOC,WAAW,cAAc;AAChC,OAAOC,mBAAmB,uBAAuB;AACjD,OAAOC,gBAAgB,oBAAoB;AAC3C,OAAOC,kBAAkB,sBAAsB;AAC/C,OAAOC,mBAAmB,uBAAuB;AAEjD,MAAMC,iBAAiB;IAACP,KAAKQ,OAAO,CAACC,WAAW;IAAOT,KAAKQ,OAAO,CAACC,WAAW,MAAM,MAAM;CAAgB;AAC3G,SAASC,WAAWC,CAAC;IACnB,OAAOJ,eAAeK,IAAI,CAAC,CAACC,IAAMF,EAAEG,UAAU,CAACD;AACjD;AAEA,MAAME,QAAQ,IAAIb;AAClB,MAAMc,SAASX,aAAaL,KAAKQ,OAAO,CAACS,QAAQC,GAAG,IAAI;AACxDF,OAAOA,MAAM,CAACG,eAAe,CAACC,MAAM,GAAG;AACvCJ,OAAOA,MAAM,CAACG,eAAe,CAACE,MAAM,GAAG;AACvC,MAAMC,QAAQnB,cAAca;AAE5B,OAAO,SAASO,SAASC,OAAO,EAAEC,QAAQ;IACxCD,UAAUA,WAAW,CAAC;IACtB,OAAOvB,QAAQyB,OAAO,CAAC,CAACC,MAAMC,WAAaC,QAAQF,MAAMC,UAAUJ,UAAUM,OAAOC,MAAM,CAAC;QAAEC,MAAM5B;IAAW,GAAGqB,YAAY,CAAC;AAChI;AAEA,OAAO,SAASI,QAAQI,QAAQ,EAAEL,QAAQ;IACxC,SAAS;IACT,IAAIlB,WAAWkB,WAAW,OAAOK;IACjC,IAAIL,SAASM,QAAQ,CAAC,UAAU,OAAO;IACvC,IAAI9B,WAAW+B,OAAO,CAACnC,KAAKoC,OAAO,CAACR,aAAa,GAAG,OAAOK,YAAY;IACvE,IAAI,CAACX,MAAMM,WAAW,OAAOK,YAAY;IAEzC,MAAMI,OAAOtB,MAAMuB,WAAW,CAACvB,MAAMwB,SAAS,CAACX,UAAUZ,SAASiB,UAAU,IAAM3B,cAAc2B,UAAUL,UAAUZ;IACpH,OAAOqB,KAAKV,IAAI;AAClB"}