{"version":3,"sources":["loaderCurrent.mjs"],"sourcesContent":["import fs from 'fs';\nimport path from 'path';\nimport { URL, fileURLToPath, pathToFileURL } from 'url';\nimport process from 'process';\n\nimport Cache from '../Cache.mjs';\nimport createMatcher from '../createMatcher.mjs';\nimport extensions from '../extensions.mjs';\nimport loadTSConfig from '../loadTSConfig.mjs';\nimport packageType from '../packageType.mjs';\nimport transformSync from '../transformSync.cjs';\n\nconst major = +process.versions.node.split('.')[0];\nconst importJSONKey = major >= 18 ? 'importAttributes' : 'importAssertions';\n\nconst INTERNAL_PATHS = [new URL('..', import.meta.url).href, new URL('../../node_modules', import.meta.url).href];\nconst isInternal = (x) => INTERNAL_PATHS.some((y) => x.startsWith(y));\n\nconst moduleRegEx = /^[^.\\/]|^\\.[^.\\/]|^\\.\\.[^\\/]/;\nconst indexExtensions = extensions.map((x) => `index${x}`);\n\nconst cache = new Cache();\nconst config = loadTSConfig(path.resolve(process.cwd(), 'tsconfig.json'));\nconst match = createMatcher(config);\n\nexport async function resolve(specifier, context, defaultResolve) {\n  if (specifier.startsWith('node:')) specifier = specifier.slice(5); // node built-in\n  const parentURL = context.parentURL && path.isAbsolute(context.parentURL) ? pathToFileURL(context.parentURL) : context.parentURL; // windows\n  const url = parentURL ? new URL(specifier, parentURL).href : new URL(specifier).href;\n\n  // resolve from extension or as a module\n  if (path.extname(specifier) || moduleRegEx.test(specifier)) {\n    const data = await defaultResolve(specifier, context, defaultResolve);\n    if (!data.format) data.format = packageType(url);\n    if (specifier.endsWith('/node_modules/yargs/yargs')) data.format = 'commonjs'; // args bin is cjs in a module\n    return data;\n  }\n\n  // directory\n  if (specifier.endsWith('/')) {\n    const items = fs.readdirSync(specifier);\n    for (const item of items) {\n      if (indexExtensions.indexOf(item) >= 0) {\n        return await resolve(specifier + item, context, defaultResolve);\n      }\n    }\n  }\n\n  // guess extension\n  else {\n    for (const ext of extensions) {\n      try {\n        return await resolve(specifier + ext, context, defaultResolve);\n      } catch (_err) {\n        // skip\n      }\n    }\n  }\n\n  throw new Error(`Cannot resolve: ${specifier}`);\n}\n\nexport async function load(url, context, defaultLoad) {\n  if (url.startsWith('node:')) return await defaultLoad(url, context, defaultLoad);\n  if (url.endsWith('.json')) context[importJSONKey] = Object.assign(context[importJSONKey] || {}, { type: 'json' });\n\n  const parentURL = context.parentURL && path.isAbsolute(context.parentURL) ? pathToFileURL(context.parentURL) : context.parentURL; // windows\n  url = parentURL ? new URL(specifier, parentURL).href : url;\n\n  const loaded = await defaultLoad(url, context, defaultLoad);\n  const filePath = fileURLToPath(url);\n  const hasSource = loaded.source;\n  if (!hasSource) loaded.source = fs.readFileSync(filePath);\n\n  // filter\n  if (isInternal(url)) return loaded;\n  if (url.endsWith('.d.ts')) return { ...loaded, format: 'module', source: '' };\n  if (extensions.indexOf(path.extname(filePath)) < 0) return loaded;\n  if (!match(filePath)) return loaded;\n\n  // transform\n  const contents = loaded.source.toString();\n  const data = cache.getOrUpdate(cache.cachePath(filePath, config), contents, () => transformSync(contents, filePath, config));\n\n  return {\n    ...loaded,\n    format: hasSource ? 'module' : 'commonjs',\n    source: data.code,\n  };\n}\n"],"names":["fs","path","URL","fileURLToPath","pathToFileURL","process","Cache","createMatcher","extensions","loadTSConfig","packageType","transformSync","major","versions","node","split","importJSONKey","INTERNAL_PATHS","url","href","isInternal","x","some","y","startsWith","moduleRegEx","indexExtensions","map","cache","config","resolve","cwd","match","specifier","context","defaultResolve","slice","parentURL","isAbsolute","extname","test","data","format","endsWith","items","readdirSync","item","indexOf","ext","_err","Error","load","defaultLoad","Object","assign","type","loaded","filePath","hasSource","source","readFileSync","contents","toString","getOrUpdate","cachePath","code"],"mappings":"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"}