{"version":3,"sources":["loaderLegacy.mjs"],"sourcesContent":["import path from 'path';\nimport isBuiltinModule from 'is-builtin-module';\n\nimport Cache from '../Cache.mjs';\nimport createMatcher from '../createMatcher.mjs';\nimport extensions from '../extensions.mjs';\nimport loadTSConfig from '../loadTSConfig.mjs';\nimport transformSync from '../transformSync.cjs';\nimport extToFormat from './extToFormat.mjs';\nimport fileType from './fileType.mjs';\nimport toPath from './toPath.mjs';\n\nconst cache = new Cache();\nconst config = loadTSConfig(path.resolve(process.cwd(), 'tsconfig.json'));\nconst match = createMatcher(config);\n\nconst typeFileRegEx = /^[^.]+\\.d\\.(.*)$/;\n\nasync function _getFormat(url, context, next) {\n  if (isBuiltinModule(url)) return next(url, context);\n  if (!url.startsWith('file://')) return await next(url, context);\n  const filePath = toPath(url, context);\n  const ext = path.extname(filePath);\n\n  // filtered\n  if (!match(filePath)) {\n    if (!ext) return { format: 'commonjs' }; // args bin is cjs in a module\n    return await next(url, context);\n  }\n\n  // file\n  const data = { format: extToFormat(ext) };\n  if (!data.format || ['.js', '.jsx'].indexOf(ext) >= 0) data.format = fileType(filePath);\n  return data;\n}\n\nasync function _transformSource(source, context, next) {\n  if (isBuiltinModule(context.url)) return next(source, context);\n  const loaded = await next(source, context);\n  const filePath = toPath(context.url);\n  const ext = path.extname(filePath);\n\n  // filtered\n  if (!match(filePath)) return loaded;\n  if (typeFileRegEx.test(filePath)) return { source: '' };\n  if (extensions.indexOf(ext) < 0) return loaded;\n\n  const contents = loaded.source.toString();\n  const compiled = cache.getOrUpdate(cache.cachePath(filePath, config), contents, () => transformSync(contents, filePath, config));\n\n  return {\n    source: compiled.code,\n  };\n}\n\nconst major = +process.versions.node.split('.')[0];\n\nexport const getFormat = major < 16 ? _getFormat : undefined;\nexport const transformSource = major < 16 ? _transformSource : undefined;\n"],"names":["path","isBuiltinModule","Cache","createMatcher","extensions","loadTSConfig","transformSync","extToFormat","fileType","toPath","cache","config","resolve","process","cwd","match","typeFileRegEx","_getFormat","url","context","next","startsWith","filePath","ext","extname","format","data","indexOf","_transformSource","source","loaded","test","contents","toString","compiled","getOrUpdate","cachePath","code","major","versions","node","split","getFormat","undefined","transformSource"],"mappings":"AAAA,OAAOA,UAAU,OAAO;AACxB,OAAOC,qBAAqB,oBAAoB;AAEhD,OAAOC,WAAW,eAAe;AACjC,OAAOC,mBAAmB,uBAAuB;AACjD,OAAOC,gBAAgB,oBAAoB;AAC3C,OAAOC,kBAAkB,sBAAsB;AAC/C,OAAOC,mBAAmB,uBAAuB;AACjD,OAAOC,iBAAiB,oBAAoB;AAC5C,OAAOC,cAAc,iBAAiB;AACtC,OAAOC,YAAY,eAAe;AAElC,MAAMC,QAAQ,IAAIR;AAClB,MAAMS,SAASN,aAAaL,KAAKY,OAAO,CAACC,QAAQC,GAAG,IAAI;AACxD,MAAMC,QAAQZ,cAAcQ;AAE5B,MAAMK,gBAAgB;AAEtB,eAAeC,WAAWC,GAAG,EAAEC,OAAO,EAAEC,IAAI;IAC1C,IAAInB,gBAAgBiB,MAAM,OAAOE,KAAKF,KAAKC;IAC3C,IAAI,CAACD,IAAIG,UAAU,CAAC,YAAY,OAAO,MAAMD,KAAKF,KAAKC;IACvD,MAAMG,WAAWb,OAAOS,KAAKC;IAC7B,MAAMI,MAAMvB,KAAKwB,OAAO,CAACF;IAEzB,WAAW;IACX,IAAI,CAACP,MAAMO,WAAW;QACpB,IAAI,CAACC,KAAK,OAAO;YAAEE,QAAQ;QAAW,GAAG,8BAA8B;QACvE,OAAO,MAAML,KAAKF,KAAKC;IACzB;IAEA,OAAO;IACP,MAAMO,OAAO;QAAED,QAAQlB,YAAYgB;IAAK;IACxC,IAAI,CAACG,KAAKD,MAAM,IAAI;QAAC;QAAO;KAAO,CAACE,OAAO,CAACJ,QAAQ,GAAGG,KAAKD,MAAM,GAAGjB,SAASc;IAC9E,OAAOI;AACT;AAEA,eAAeE,iBAAiBC,MAAM,EAAEV,OAAO,EAAEC,IAAI;IACnD,IAAInB,gBAAgBkB,QAAQD,GAAG,GAAG,OAAOE,KAAKS,QAAQV;IACtD,MAAMW,SAAS,MAAMV,KAAKS,QAAQV;IAClC,MAAMG,WAAWb,OAAOU,QAAQD,GAAG;IACnC,MAAMK,MAAMvB,KAAKwB,OAAO,CAACF;IAEzB,WAAW;IACX,IAAI,CAACP,MAAMO,WAAW,OAAOQ;IAC7B,IAAId,cAAce,IAAI,CAACT,WAAW,OAAO;QAAEO,QAAQ;IAAG;IACtD,IAAIzB,WAAWuB,OAAO,CAACJ,OAAO,GAAG,OAAOO;IAExC,MAAME,WAAWF,OAAOD,MAAM,CAACI,QAAQ;IACvC,MAAMC,WAAWxB,MAAMyB,WAAW,CAACzB,MAAM0B,SAAS,CAACd,UAAUX,SAASqB,UAAU,IAAM1B,cAAc0B,UAAUV,UAAUX;IAExH,OAAO;QACLkB,QAAQK,SAASG,IAAI;IACvB;AACF;AAEA,MAAMC,QAAQ,CAACzB,QAAQ0B,QAAQ,CAACC,IAAI,CAACC,KAAK,CAAC,IAAI,CAAC,EAAE;AAElD,OAAO,MAAMC,YAAYJ,QAAQ,KAAKrB,aAAa0B,UAAU;AAC7D,OAAO,MAAMC,kBAAkBN,QAAQ,KAAKV,mBAAmBe,UAAU"}