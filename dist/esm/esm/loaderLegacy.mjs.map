{"version":3,"sources":["loaderLegacy.mjs"],"sourcesContent":["import path from 'path';\nimport { URL, fileURLToPath, pathToFileURL } from 'url';\n\nimport Cache from '../Cache.mjs';\nimport createMatcher from '../createMatcher.mjs';\nimport extensions from '../extensions.mjs';\nimport loadTSConfig from '../loadTSConfig.mjs';\nimport packageType from '../packageType.mjs';\nimport transformSync from '../transformSync.cjs';\n\nconst INTERNAL_PATHS = [new URL('..', import.meta.url).href, new URL('../../node_modules', import.meta.url).href];\nconst isInternal = (x) => INTERNAL_PATHS.some((y) => x.startsWith(y));\n\nconst EXT_TO_FORMAT = {\n  '.json': 'json',\n  '.mjs': 'module',\n  '.mts': 'module',\n  '.cjs': 'commonjs',\n  '.cts': 'commonjs',\n};\n\nconst cache = new Cache();\nconst config = loadTSConfig(path.resolve(process.cwd(), 'tsconfig.json'));\nconst match = createMatcher(config);\n\nasync function _getFormat(url, context, defaultGetFormat) {\n  const parentURL = context.parentURL && path.isAbsolute(context.parentURL) ? pathToFileURL(context.parentURL) : context.parentURL; // windows\n  url = parentURL ? new URL(specifier, parentURL).href : url;\n\n  // internals\n  if (isInternal(url)) return { format: packageType(url) };\n\n  // file\n  if (url.startsWith('file://')) {\n    let format = EXT_TO_FORMAT[path.extname(url)];\n    if (!format) format = packageType(url);\n    if (url.endsWith('/node_modules/yargs/yargs')) format = 'commonjs'; // args bin is cjs in a module\n    return { format };\n  }\n\n  // relative\n  return await defaultGetFormat(url, context, defaultGetFormat);\n}\n\nasync function _transformSource(source, context, defaultTransformSource) {\n  let { url } = context;\n  const parentURL = context.parentURL && path.isAbsolute(context.parentURL) ? pathToFileURL(context.parentURL) : context.parentURL; // windows\n  url = parentURL ? new URL(specifier, parentURL).href : url;\n  const loaded = await defaultTransformSource(source, context, defaultTransformSource);\n  const filePath = fileURLToPath(url);\n\n  // filter\n  if (isInternal(url)) return loaded;\n  if (url.endsWith('.d.ts')) return { source: '' };\n  if (extensions.indexOf(path.extname(filePath)) < 0) return loaded;\n  if (!match(filePath)) return loaded;\n\n  const contents = loaded.source.toString();\n  const data = cache.getOrUpdate(cache.cachePath(filePath, config), contents, () => transformSync(contents, filePath, config));\n\n  return {\n    source: data.code,\n  };\n}\n\nconst major = +process.versions.node.split('.')[0];\n\nexport const getFormat = major < 16 ? _getFormat : undefined;\nexport const transformSource = major < 16 ? _transformSource : undefined;\n"],"names":["path","URL","fileURLToPath","pathToFileURL","Cache","createMatcher","extensions","loadTSConfig","packageType","transformSync","INTERNAL_PATHS","url","href","isInternal","x","some","y","startsWith","EXT_TO_FORMAT","cache","config","resolve","process","cwd","match","_getFormat","context","defaultGetFormat","parentURL","isAbsolute","specifier","format","extname","endsWith","_transformSource","source","defaultTransformSource","loaded","filePath","indexOf","contents","toString","data","getOrUpdate","cachePath","code","major","versions","node","split","getFormat","undefined","transformSource"],"mappings":"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"}